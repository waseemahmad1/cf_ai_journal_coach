<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI Journal Coach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --radius: 12px; }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #f7f7f8; color: #111; margin: 0; padding: 24px;
    }
    .container {
      max-width: 760px; margin: 0 auto; background: #fff; border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.06); overflow: hidden; display: flex; flex-direction: column; height: 90vh;
    }
    header { padding: 16px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
    header h1 { font-size: 18px; margin: 0; }
    #chat {
      flex: 1; padding: 20px; overflow-y: auto; background: #fafafa;
    }
    .msg { margin: 12px 0; line-height: 1.45; }
    .you .bubble { background: #e9f2ff; align-self: flex-end; }
    .bot .bubble { background: #f0f0f0; }
    .bubble {
      display: inline-block; padding: 12px 14px; border-radius: 14px; max-width: 80%;
      white-space: pre-wrap; word-wrap: break-word;
    }
    .row { display: flex; margin: 8px 0; }
    .you { justify-content: flex-end; }
    .bot { justify-content: flex-start; }
    .meta { font-size: 12px; color: #666; margin: 4px 2px 0; }
    footer {
      border-top: 1px solid #eee; padding: 12px; display: flex; gap: 8px; background: #fff;
    }
    input[type="text"], textarea {
      flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; resize: none; min-height: 44px;
      outline: none; background: #fff;
    }
    button {
      padding: 0 16px; min-width: 96px; border: 0; border-radius: 10px; background: #111; color: #fff;
      font-weight: 600; cursor: pointer; height: 44px;
    }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .hint { padding: 10px 20px; font-size: 13px; color: #666; border-top: 1px dashed #eee; background: #fbfbfb; }
    .spinner {
      display: inline-block; width: 16px; height: 16px; border: 2px solid #ccc; border-top-color: #111;
      border-radius: 50%; animation: spin 0.9s linear infinite; vertical-align: middle; margin-left: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 3c4.97 0 9 3.582 9 8 0 4.418-4.03 8-9 8-.98 0-1.93-.125-2.82-.36-.33-.086-.68-.02-.95.18L4.5 21l1.28-3.2c.12-.3.08-.64-.11-.9C4.63 15.6 4 14.35 4 13c0-4.418 4.03-8 8-8Z" stroke="#111" stroke-width="1.5" />
      </svg>
      <h1>AI Journal Coach</h1>
    </header>

    <div id="chat"></div>

    <div class="hint">Tip: press <b>Enter</b> to send. Shift + Enter for a new line.</div>

    <footer>
      <textarea id="msg" placeholder="How was your day? What’s on your mind…" rows="2"></textarea>
      <button id="sendBtn" onclick="sendMsg()">Send</button>
    </footer>
  </div>

  <script>
    const WORKER_URL = "https://cf_ai_journal_coach.waseemahmad.workers.dev/chat";

    const chat = document.getElementById("chat");
    const input = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");
    const STORAGE_KEY = "journal_chat_history_v1";
    const MAX_RENDERED = 100; // soft limit on rendered messages

    function saveHistory(items) {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(items.slice(-MAX_RENDERED))); } catch {}
    }
    function loadHistory() {
      try {
        const s = localStorage.getItem(STORAGE_KEY);
        return s ? JSON.parse(s) : [];
      } catch { return []; }
    }

    // Restore previous messages
    const history = loadHistory();
    history.forEach(m => render(m.role, m.content, false));

    input.focus();

    // Enter to send
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMsg();
      }
    });

    async function sendMsg() {
      const msg = input.value.trim();
      if (!msg) return;
      setLoading(true);
      render("you", msg);
      history.push({ role: "you", content: msg });
      saveHistory(history);
      input.value = "";

      try {
        const res = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg }),
        });

        if (!res.ok) {
          const txt = await safeText(res);
          render("bot", "Error from server: " + (txt || res.status), true);
          return;
        }
        const data = await res.json();
        const reply = data.reply || "(no reply)";
        render("bot", reply);
        history.push({ role: "bot", content: reply });
        saveHistory(history);
      } catch (err) {
        console.error(err);
        render("bot", "Network error.", true);
      } finally {
        setLoading(false);
      }
    }

    function render(role, text, isError=false) {
      const row = document.createElement("div");
      row.className = "row " + (role === "you" ? "you" : "bot");

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = escapeHTML(text);
      if (isError) bubble.style.border = "1px solid #f33";

      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    function setLoading(on) {
      sendBtn.disabled = on;
      if (on) {
        sendBtn.innerHTML = 'Sending <span class="spinner"></span>';
      } else {
        sendBtn.textContent = "Send";
      }
    }

    function escapeHTML(s) {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    async function safeText(res) {
      try { return await res.text(); } catch { return ""; }
    }
  </script>
</body>
</html>
